
.. DO NOT EDIT.
.. THIS FILE WAS AUTOMATICALLY GENERATED BY SPHINX-GALLERY.
.. TO MAKE CHANGES, EDIT THE SOURCE PYTHON FILE:
.. "auto_examples/sampling/demo_diffusion_sde.py"
.. LINE NUMBERS ARE GIVEN BELOW.

.. only:: html

    .. note::
        :class: sphx-glr-download-link-note

        :ref:`Go to the end <sphx_glr_download_auto_examples_sampling_demo_diffusion_sde.py>`
        to download the full example code.

.. rst-class:: sphx-glr-example-title

.. _sphx_glr_auto_examples_sampling_demo_diffusion_sde.py:


Building your diffusion posterior sampling method using SDEs
============================================================

This demo shows you how to use
:class:`deepinv.sampling.PosteriorDiffusion` to perform posterior sampling. It also can be used to perform unconditional image generation with arbitrary denoisers, if the data fidelity term is not specified.

This method requires:

* A well-trained denoiser with varying noise levels (ideally with large noise levels) (e.g., :class:`deepinv.models.NCSNpp`).

* A (noisy) data fidelity term (e.g., :class:`deepinv.sampling.DPSDataFidelity`).

* Define a drift term :math:`f(x, t)` and a diffusion term :math:`g(t)` for the forward-time SDE. They can be defined through the :class:`deepinv.sampling.DiffusionSDE` (e.g., :class:`deepinv.sampling.VarianceExplodingDiffusion`).

The :class:`deepinv.sampling.PosteriorDiffusion` class can be used to perform posterior sampling for inverse problems.
Consider the acquisition model:

.. math::
     y = \noise{\forw{x}}

where :math:`\forw{x}` is the forward operator (e.g., a convolutional operator) and :math:`\noise{\cdot}` is the noise operator (e.g., Gaussian noise).
This class defines the reverse-time SDE for the posterior distribution :math:`p(x|y)` given the data :math:`y`:

.. math::
     d\, x_t = \left( f(x_t, t) - \frac{1 + \alpha}{2} g(t)^2 \nabla_{x_t} \log p_t(x_t | y) \right) d\,t + g(t) \sqrt{\alpha} d\, w_{t}

where :math:`f` is the drift term, :math:`g` is the diffusion coefficient and :math:`w` is the standard Brownian motion.
The drift term and the diffusion coefficient are defined by the underlying (unconditional) forward-time SDE `sde`.
In this example, we will use 2 well-known SDE in the literature: the Variance-Exploding (VE) and Variance-Preserving (VP or DDPM).

The (conditional) score function :math:`\nabla_{x_t} \log p_t(x_t | y)` can be decomposed using the Bayes' rule:

.. math::
     \nabla_{x_t} \log p_t(x_t | y) = \nabla_{x_t} \log p_t(x_t) + \nabla_{x_t} \log p_t(y | x_t).

The first term is the score function of the unconditional SDE, which is typically approximated by an MMSE denoiser (`denoiser`) using the well-known Tweedie's formula, while the
second term is approximated by the (noisy) data-fidelity term (`data_fidelity`).
We implement various data-fidelity terms in `the user guide <https://deepinv.github.io/deepinv/user_guide/reconstruction/sampling.html#id2>`_.

.. note::

    In this demo, we limit the number of diffusion steps for the sake of speed, but in practice, you should use a larger number of steps to obtain better results.

.. GENERATED FROM PYTHON SOURCE LINES 47-55

---------------------------------------------------

Let us import the necessary modules, define the denoiser and the SDE.

In this first example, we use the Variance-Exploding SDE, whose forward process is defined as:

.. math::
    d\, x_t = g(t) d\, w_t \quad \mbox{where } g(t) = \sigma_{\mathrm{min}}\left( \frac{\sigma_{\mathrm{max}}}{\sigma_{\mathrm{min}}}\right)^t

.. GENERATED FROM PYTHON SOURCE LINES 55-64

.. code-block:: Python


    import torch
    import deepinv as dinv
    from deepinv.models import NCSNpp

    device = "cuda" if torch.cuda.is_available() else "cpu"
    dtype = torch.float64
    figsize = 2.5
    gif_frequency = 10  # Increase this value to save the GIF saving time







.. GENERATED FROM PYTHON SOURCE LINES 65-96

.. code-block:: Python

    from deepinv.sampling import (
        PosteriorDiffusion,
        DPSDataFidelity,
        EulerSolver,
        VarianceExplodingDiffusion,
    )
    from deepinv.optim import ZeroFidelity

    # In this example, we use the pre-trained FFHQ-64 model from the
    # EDM framework: https://arxiv.org/pdf/2206.00364 .
    # The network architecture is from Song et al: https://arxiv.org/abs/2011.13456 .
    denoiser = NCSNpp(pretrained="download").to(device)

    # The solution is obtained by calling the SDE object with a desired solver (here, Euler).
    # The reproducibility of the SDE Solver class can be controlled by providing the pseudo-random number generator.
    num_steps = 150
    rng = torch.Generator(device).manual_seed(42)
    timesteps = torch.linspace(1, 0.001, num_steps)
    solver = EulerSolver(timesteps=timesteps, rng=rng)


    sigma_min = 0.005
    sigma_max = 5
    sde = VarianceExplodingDiffusion(
        sigma_max=sigma_max,
        sigma_min=sigma_min,
        alpha=0.5,
        device=device,
        dtype=dtype,
    )





.. rst-class:: sphx-glr-script-out

 .. code-block:: none

    Downloading: "https://huggingface.co/deepinv/edm/resolve/main/ncsnpp-ffhq64-uncond-ve.pt?download=true" to /home/runner/.cache/torch/hub/checkpoints/ncsnpp-ffhq64-uncond-ve.pt
      0%|          | 0.00/240M [00:00<?, ?B/s]      7%|▋         | 17.1M/240M [00:00<00:01, 179MB/s]     15%|█▌        | 36.9M/240M [00:00<00:01, 195MB/s]     29%|██▉       | 69.6M/240M [00:00<00:00, 262MB/s]     44%|████▍     | 106M/240M [00:00<00:00, 307MB/s]      60%|██████    | 144M/240M [00:00<00:00, 343MB/s]     76%|███████▋  | 183M/240M [00:00<00:00, 363MB/s]     92%|█████████▏| 222M/240M [00:00<00:00, 377MB/s]    100%|██████████| 240M/240M [00:00<00:00, 335MB/s]




.. GENERATED FROM PYTHON SOURCE LINES 97-102

Reverse-time SDE as sampling process
--------------------------------------

When the data fidelity is not given, the posterior diffusion is equivalent to the unconditional diffusion.
Sampling is performed by solving the reverse-time SDE. To do so, we generate a reverse-time trajectory.

.. GENERATED FROM PYTHON SOURCE LINES 102-134

.. code-block:: Python


    model = PosteriorDiffusion(
        data_fidelity=ZeroFidelity(),
        sde=sde,
        denoiser=denoiser,
        solver=solver,
        dtype=dtype,
        device=device,
        verbose=True,
    )
    x, trajectory = model(
        y=None,
        physics=None,
        x_init=(1, 3, 64, 64),
        seed=1,
        get_trajectory=True,
    )
    dinv.utils.plot(
        x,
        titles="Unconditional generation",
        save_fn="sde_sample.png",
        figsize=(figsize, figsize),
    )

    dinv.utils.save_videos(
        trajectory.cpu()[::gif_frequency],
        time_dim=0,
        titles=["VE-SDE Trajectory"],
        save_fn="sde_trajectory.gif",
        figsize=(figsize, figsize),
    )





.. rst-class:: sphx-glr-script-out

 .. code-block:: none

      0%|          | 0/149 [00:00<?, ?it/s]      1%|          | 1/149 [00:00<01:20,  1.83it/s]      1%|▏         | 2/149 [00:01<01:19,  1.86it/s]      2%|▏         | 3/149 [00:01<01:18,  1.86it/s]      3%|▎         | 4/149 [00:02<01:17,  1.87it/s]      3%|▎         | 5/149 [00:02<01:17,  1.87it/s]      4%|▍         | 6/149 [00:03<01:16,  1.87it/s]      5%|▍         | 7/149 [00:03<01:15,  1.87it/s]      5%|▌         | 8/149 [00:04<01:15,  1.87it/s]      6%|▌         | 9/149 [00:04<01:14,  1.87it/s]      7%|▋         | 10/149 [00:05<01:14,  1.87it/s]      7%|▋         | 11/149 [00:05<01:13,  1.87it/s]      8%|▊         | 12/149 [00:06<01:13,  1.87it/s]      9%|▊         | 13/149 [00:06<01:12,  1.87it/s]      9%|▉         | 14/149 [00:07<01:12,  1.87it/s]     10%|█         | 15/149 [00:08<01:11,  1.87it/s]     11%|█         | 16/149 [00:08<01:11,  1.86it/s]     11%|█▏        | 17/149 [00:09<01:10,  1.86it/s]     12%|█▏        | 18/149 [00:09<01:10,  1.86it/s]     13%|█▎        | 19/149 [00:10<01:09,  1.87it/s]     13%|█▎        | 20/149 [00:10<01:09,  1.87it/s]     14%|█▍        | 21/149 [00:11<01:08,  1.87it/s]     15%|█▍        | 22/149 [00:11<01:07,  1.87it/s]     15%|█▌        | 23/149 [00:12<01:07,  1.87it/s]     16%|█▌        | 24/149 [00:12<01:06,  1.87it/s]     17%|█▋        | 25/149 [00:13<01:06,  1.87it/s]     17%|█▋        | 26/149 [00:13<01:05,  1.87it/s]     18%|█▊        | 27/149 [00:14<01:05,  1.87it/s]     19%|█▉        | 28/149 [00:14<01:04,  1.87it/s]     19%|█▉        | 29/149 [00:15<01:04,  1.87it/s]     20%|██        | 30/149 [00:16<01:03,  1.87it/s]     21%|██        | 31/149 [00:16<01:03,  1.87it/s]     21%|██▏       | 32/149 [00:17<01:02,  1.87it/s]     22%|██▏       | 33/149 [00:17<01:02,  1.87it/s]     23%|██▎       | 34/149 [00:18<01:01,  1.87it/s]     23%|██▎       | 35/149 [00:18<01:01,  1.85it/s]     24%|██▍       | 36/149 [00:19<01:00,  1.86it/s]     25%|██▍       | 37/149 [00:19<01:00,  1.85it/s]     26%|██▌       | 38/149 [00:20<00:59,  1.86it/s]     26%|██▌       | 39/149 [00:20<00:59,  1.86it/s]     27%|██▋       | 40/149 [00:21<00:58,  1.86it/s]     28%|██▊       | 41/149 [00:21<00:57,  1.87it/s]     28%|██▊       | 42/149 [00:22<00:57,  1.87it/s]     29%|██▉       | 43/149 [00:23<00:56,  1.87it/s]     30%|██▉       | 44/149 [00:23<00:56,  1.87it/s]     30%|███       | 45/149 [00:24<00:55,  1.87it/s]     31%|███       | 46/149 [00:24<00:55,  1.87it/s]     32%|███▏      | 47/149 [00:25<00:54,  1.87it/s]     32%|███▏      | 48/149 [00:25<00:54,  1.87it/s]     33%|███▎      | 49/149 [00:26<00:53,  1.87it/s]     34%|███▎      | 50/149 [00:26<00:52,  1.87it/s]     34%|███▍      | 51/149 [00:27<00:52,  1.87it/s]     35%|███▍      | 52/149 [00:27<00:51,  1.87it/s]     36%|███▌      | 53/149 [00:28<00:51,  1.87it/s]     36%|███▌      | 54/149 [00:28<00:50,  1.87it/s]     37%|███▋      | 55/149 [00:29<00:50,  1.87it/s]     38%|███▊      | 56/149 [00:29<00:49,  1.87it/s]     38%|███▊      | 57/149 [00:30<00:49,  1.87it/s]     39%|███▉      | 58/149 [00:31<00:48,  1.87it/s]     40%|███▉      | 59/149 [00:31<00:48,  1.87it/s]     40%|████      | 60/149 [00:32<00:47,  1.87it/s]     41%|████      | 61/149 [00:32<00:47,  1.87it/s]     42%|████▏     | 62/149 [00:33<00:46,  1.87it/s]     42%|████▏     | 63/149 [00:33<00:45,  1.87it/s]     43%|████▎     | 64/149 [00:34<00:45,  1.86it/s]     44%|████▎     | 65/149 [00:34<00:45,  1.87it/s]     44%|████▍     | 66/149 [00:35<00:44,  1.87it/s]     45%|████▍     | 67/149 [00:35<00:43,  1.87it/s]     46%|████▌     | 68/149 [00:36<00:43,  1.87it/s]     46%|████▋     | 69/149 [00:36<00:42,  1.87it/s]     47%|████▋     | 70/149 [00:37<00:42,  1.87it/s]     48%|████▊     | 71/149 [00:38<00:41,  1.87it/s]     48%|████▊     | 72/149 [00:38<00:41,  1.87it/s]     49%|████▉     | 73/149 [00:39<00:40,  1.87it/s]     50%|████▉     | 74/149 [00:39<00:40,  1.87it/s]     50%|█████     | 75/149 [00:40<00:39,  1.87it/s]     51%|█████     | 76/149 [00:40<00:39,  1.87it/s]     52%|█████▏    | 77/149 [00:41<00:38,  1.87it/s]     52%|█████▏    | 78/149 [00:41<00:37,  1.87it/s]     53%|█████▎    | 79/149 [00:42<00:37,  1.87it/s]     54%|█████▎    | 80/149 [00:42<00:36,  1.87it/s]     54%|█████▍    | 81/149 [00:43<00:36,  1.87it/s]     55%|█████▌    | 82/149 [00:43<00:35,  1.87it/s]     56%|█████▌    | 83/149 [00:44<00:35,  1.87it/s]     56%|█████▋    | 84/149 [00:44<00:34,  1.87it/s]     57%|█████▋    | 85/149 [00:45<00:34,  1.87it/s]     58%|█████▊    | 86/149 [00:46<00:33,  1.87it/s]     58%|█████▊    | 87/149 [00:46<00:33,  1.87it/s]     59%|█████▉    | 88/149 [00:47<00:32,  1.87it/s]     60%|█████▉    | 89/149 [00:47<00:32,  1.87it/s]     60%|██████    | 90/149 [00:48<00:31,  1.87it/s]     61%|██████    | 91/149 [00:48<00:31,  1.87it/s]     62%|██████▏   | 92/149 [00:49<00:30,  1.87it/s]     62%|██████▏   | 93/149 [00:49<00:29,  1.87it/s]     63%|██████▎   | 94/149 [00:50<00:29,  1.87it/s]     64%|██████▍   | 95/149 [00:50<00:28,  1.87it/s]     64%|██████▍   | 96/149 [00:51<00:28,  1.87it/s]     65%|██████▌   | 97/149 [00:51<00:27,  1.87it/s]     66%|██████▌   | 98/149 [00:52<00:27,  1.87it/s]     66%|██████▋   | 99/149 [00:52<00:26,  1.87it/s]     67%|██████▋   | 100/149 [00:53<00:26,  1.87it/s]     68%|██████▊   | 101/149 [00:54<00:25,  1.87it/s]     68%|██████▊   | 102/149 [00:54<00:25,  1.87it/s]     69%|██████▉   | 103/149 [00:55<00:24,  1.85it/s]     70%|██████▉   | 104/149 [00:55<00:24,  1.86it/s]     70%|███████   | 105/149 [00:56<00:23,  1.86it/s]     71%|███████   | 106/149 [00:56<00:23,  1.86it/s]     72%|███████▏  | 107/149 [00:57<00:22,  1.87it/s]     72%|███████▏  | 108/149 [00:57<00:21,  1.87it/s]     73%|███████▎  | 109/149 [00:58<00:21,  1.87it/s]     74%|███████▍  | 110/149 [00:58<00:20,  1.87it/s]     74%|███████▍  | 111/149 [00:59<00:20,  1.87it/s]     75%|███████▌  | 112/149 [00:59<00:19,  1.87it/s]     76%|███████▌  | 113/149 [01:00<00:19,  1.87it/s]     77%|███████▋  | 114/149 [01:01<00:18,  1.87it/s]     77%|███████▋  | 115/149 [01:01<00:18,  1.87it/s]     78%|███████▊  | 116/149 [01:02<00:17,  1.87it/s]     79%|███████▊  | 117/149 [01:02<00:17,  1.87it/s]     79%|███████▉  | 118/149 [01:03<00:16,  1.87it/s]     80%|███████▉  | 119/149 [01:03<00:16,  1.87it/s]     81%|████████  | 120/149 [01:04<00:15,  1.87it/s]     81%|████████  | 121/149 [01:04<00:14,  1.87it/s]     82%|████████▏ | 122/149 [01:05<00:14,  1.87it/s]     83%|████████▎ | 123/149 [01:05<00:13,  1.87it/s]     83%|████████▎ | 124/149 [01:06<00:13,  1.87it/s]     84%|████████▍ | 125/149 [01:06<00:12,  1.87it/s]     85%|████████▍ | 126/149 [01:07<00:12,  1.87it/s]     85%|████████▌ | 127/149 [01:07<00:11,  1.87it/s]     86%|████████▌ | 128/149 [01:08<00:11,  1.87it/s]     87%|████████▋ | 129/149 [01:09<00:10,  1.86it/s]     87%|████████▋ | 130/149 [01:09<00:10,  1.87it/s]     88%|████████▊ | 131/149 [01:10<00:09,  1.87it/s]     89%|████████▊ | 132/149 [01:10<00:09,  1.87it/s]     89%|████████▉ | 133/149 [01:11<00:08,  1.87it/s]     90%|████████▉ | 134/149 [01:11<00:08,  1.87it/s]     91%|█████████ | 135/149 [01:12<00:07,  1.87it/s]     91%|█████████▏| 136/149 [01:12<00:06,  1.87it/s]     92%|█████████▏| 137/149 [01:13<00:06,  1.87it/s]     93%|█████████▎| 138/149 [01:13<00:05,  1.87it/s]     93%|█████████▎| 139/149 [01:14<00:05,  1.87it/s]     94%|█████████▍| 140/149 [01:14<00:04,  1.87it/s]     95%|█████████▍| 141/149 [01:15<00:04,  1.87it/s]     95%|█████████▌| 142/149 [01:15<00:03,  1.87it/s]     96%|█████████▌| 143/149 [01:16<00:03,  1.87it/s]     97%|█████████▋| 144/149 [01:17<00:02,  1.87it/s]     97%|█████████▋| 145/149 [01:17<00:02,  1.87it/s]     98%|█████████▊| 146/149 [01:18<00:01,  1.87it/s]     99%|█████████▊| 147/149 [01:18<00:01,  1.86it/s]     99%|█████████▉| 148/149 [01:19<00:00,  1.87it/s]    100%|██████████| 149/149 [01:19<00:00,  1.87it/s]    100%|██████████| 149/149 [01:19<00:00,  1.87it/s]




.. GENERATED FROM PYTHON SOURCE LINES 152-167

We obtain the following unconditional sample

.. container:: image-row

   .. image-sg-ignore:: /auto_examples/images/sde_sample.png
      :alt: example of unconditional sample
      :srcset: /auto_examples/images/sde_sample.png
      :class: custom-img
      :ignore_missing: true

   .. image-sg-ignore:: /auto_examples/images/sde_trajectory.gif
      :alt: example of unconditional trajectory
      :srcset: /auto_examples/images/sde_trajectory.gif
      :class: custom-gif
      :ignore_missing: true

.. GENERATED FROM PYTHON SOURCE LINES 169-172

When the data fidelity is given, together with the measurements and the physics, this class can be used to perform posterior sampling for inverse problems.
For example, consider the inpainting problem, where we have a noisy image and we want to recover the original image.
We can use the :class:`deepinv.sampling.DPSDataFidelity` as the data fidelity term.

.. GENERATED FROM PYTHON SOURCE LINES 173-219

.. code-block:: Python


    del trajectory  # clean memory
    mask = torch.ones_like(x)
    mask[..., 24:40, 24:40] = 0.0
    physics = dinv.physics.Inpainting(img_size=x.shape[1:], mask=mask, device=device)
    y = physics(x)

    weight = 1.0  # guidance strength
    dps_fidelity = DPSDataFidelity(denoiser=denoiser, weight=weight)

    model = PosteriorDiffusion(
        data_fidelity=dps_fidelity,
        denoiser=denoiser,
        sde=sde,
        solver=solver,
        dtype=dtype,
        device=device,
        verbose=True,
    )

    # To perform posterior sampling, we need to provide the measurements, the physics and the solver.
    # Moreover, when the physics is given, the initial point can be inferred from the physics if not given explicitly.
    seed_1 = 11
    x_hat, trajectory = model(
        y,
        physics,
        seed=seed_1,
        get_trajectory=True,
    )
    # Here, we plot the original image, the measurement and the posterior sample
    dinv.utils.plot(
        [x, y, x_hat],
        show=True,
        titles=["Original", "Measurement", "Posterior sample"],
        save_fn="posterior_sample.png",
        figsize=(figsize * 3, figsize),
    )
    # We can also save the trajectory of the posterior sample
    dinv.utils.save_videos(
        trajectory[::gif_frequency],
        time_dim=0,
        titles=["Posterior sample with VE"],
        save_fn="posterior_trajectory.gif",
        figsize=(figsize, figsize),
    )





.. rst-class:: sphx-glr-script-out

 .. code-block:: none

      0%|          | 0/149 [00:00<?, ?it/s]      1%|          | 1/149 [00:01<03:57,  1.61s/it]      1%|▏         | 2/149 [00:03<03:55,  1.60s/it]      2%|▏         | 3/149 [00:04<03:53,  1.60s/it]      3%|▎         | 4/149 [00:06<03:52,  1.60s/it]      3%|▎         | 5/149 [00:08<03:50,  1.60s/it]      4%|▍         | 6/149 [00:09<03:48,  1.60s/it]      5%|▍         | 7/149 [00:11<03:47,  1.60s/it]      5%|▌         | 8/149 [00:12<03:45,  1.60s/it]      6%|▌         | 9/149 [00:14<03:43,  1.60s/it]      7%|▋         | 10/149 [00:16<03:42,  1.60s/it]      7%|▋         | 11/149 [00:17<03:40,  1.60s/it]      8%|▊         | 12/149 [00:19<03:39,  1.60s/it]      9%|▊         | 13/149 [00:20<03:37,  1.60s/it]      9%|▉         | 14/149 [00:22<03:36,  1.60s/it]     10%|█         | 15/149 [00:24<03:34,  1.60s/it]     11%|█         | 16/149 [00:25<03:33,  1.61s/it]     11%|█▏        | 17/149 [00:27<03:31,  1.60s/it]     12%|█▏        | 18/149 [00:28<03:29,  1.60s/it]     13%|█▎        | 19/149 [00:30<03:28,  1.60s/it]     13%|█▎        | 20/149 [00:32<03:26,  1.60s/it]     14%|█▍        | 21/149 [00:33<03:25,  1.60s/it]     15%|█▍        | 22/149 [00:35<03:23,  1.60s/it]     15%|█▌        | 23/149 [00:36<03:22,  1.60s/it]     16%|█▌        | 24/149 [00:38<03:20,  1.60s/it]     17%|█▋        | 25/149 [00:40<03:18,  1.60s/it]     17%|█▋        | 26/149 [00:41<03:17,  1.60s/it]     18%|█▊        | 27/149 [00:43<03:15,  1.60s/it]     19%|█▉        | 28/149 [00:44<03:13,  1.60s/it]     19%|█▉        | 29/149 [00:46<03:12,  1.60s/it]     20%|██        | 30/149 [00:48<03:10,  1.60s/it]     21%|██        | 31/149 [00:49<03:09,  1.60s/it]     21%|██▏       | 32/149 [00:51<03:07,  1.60s/it]     22%|██▏       | 33/149 [00:52<03:05,  1.60s/it]     23%|██▎       | 34/149 [00:54<03:04,  1.60s/it]     23%|██▎       | 35/149 [00:56<03:02,  1.60s/it]     24%|██▍       | 36/149 [00:57<03:01,  1.60s/it]     25%|██▍       | 37/149 [00:59<02:59,  1.60s/it]     26%|██▌       | 38/149 [01:00<02:57,  1.60s/it]     26%|██▌       | 39/149 [01:02<02:56,  1.60s/it]     27%|██▋       | 40/149 [01:04<02:54,  1.60s/it]     28%|██▊       | 41/149 [01:05<02:52,  1.60s/it]     28%|██▊       | 42/149 [01:07<02:51,  1.60s/it]     29%|██▉       | 43/149 [01:08<02:49,  1.60s/it]     30%|██▉       | 44/149 [01:10<02:48,  1.60s/it]     30%|███       | 45/149 [01:12<02:46,  1.60s/it]     31%|███       | 46/149 [01:13<02:44,  1.60s/it]     32%|███▏      | 47/149 [01:15<02:43,  1.60s/it]     32%|███▏      | 48/149 [01:16<02:41,  1.60s/it]     33%|███▎      | 49/149 [01:18<02:40,  1.60s/it]     34%|███▎      | 50/149 [01:20<02:38,  1.60s/it]     34%|███▍      | 51/149 [01:21<02:36,  1.60s/it]     35%|███▍      | 52/149 [01:23<02:35,  1.60s/it]     36%|███▌      | 53/149 [01:24<02:34,  1.61s/it]     36%|███▌      | 54/149 [01:26<02:32,  1.61s/it]     37%|███▋      | 55/149 [01:28<02:30,  1.60s/it]     38%|███▊      | 56/149 [01:29<02:29,  1.60s/it]     38%|███▊      | 57/149 [01:31<02:27,  1.60s/it]     39%|███▉      | 58/149 [01:32<02:25,  1.60s/it]     40%|███▉      | 59/149 [01:34<02:24,  1.60s/it]     40%|████      | 60/149 [01:36<02:22,  1.60s/it]     41%|████      | 61/149 [01:37<02:21,  1.60s/it]     42%|████▏     | 62/149 [01:39<02:19,  1.60s/it]     42%|████▏     | 63/149 [01:40<02:17,  1.60s/it]     43%|████▎     | 64/149 [01:42<02:16,  1.60s/it]     44%|████▎     | 65/149 [01:44<02:14,  1.60s/it]     44%|████▍     | 66/149 [01:45<02:12,  1.60s/it]     45%|████▍     | 67/149 [01:47<02:11,  1.60s/it]     46%|████▌     | 68/149 [01:48<02:10,  1.61s/it]     46%|████▋     | 69/149 [01:50<02:08,  1.61s/it]     47%|████▋     | 70/149 [01:52<02:06,  1.61s/it]     48%|████▊     | 71/149 [01:53<02:05,  1.60s/it]     48%|████▊     | 72/149 [01:55<02:03,  1.60s/it]     49%|████▉     | 73/149 [01:56<02:01,  1.60s/it]     50%|████▉     | 74/149 [01:58<02:00,  1.60s/it]     50%|█████     | 75/149 [02:00<01:58,  1.60s/it]     51%|█████     | 76/149 [02:01<01:56,  1.60s/it]     52%|█████▏    | 77/149 [02:03<01:55,  1.60s/it]     52%|█████▏    | 78/149 [02:04<01:53,  1.60s/it]     53%|█████▎    | 79/149 [02:06<01:52,  1.60s/it]     54%|█████▎    | 80/149 [02:08<01:50,  1.60s/it]     54%|█████▍    | 81/149 [02:09<01:49,  1.60s/it]     55%|█████▌    | 82/149 [02:11<01:47,  1.60s/it]     56%|█████▌    | 83/149 [02:13<01:45,  1.60s/it]     56%|█████▋    | 84/149 [02:14<01:44,  1.60s/it]     57%|█████▋    | 85/149 [02:16<01:42,  1.60s/it]     58%|█████▊    | 86/149 [02:17<01:40,  1.60s/it]     58%|█████▊    | 87/149 [02:19<01:39,  1.60s/it]     59%|█████▉    | 88/149 [02:21<01:37,  1.60s/it]     60%|█████▉    | 89/149 [02:22<01:36,  1.60s/it]     60%|██████    | 90/149 [02:24<01:34,  1.60s/it]     61%|██████    | 91/149 [02:25<01:33,  1.61s/it]     62%|██████▏   | 92/149 [02:27<01:31,  1.61s/it]     62%|██████▏   | 93/149 [02:29<01:29,  1.61s/it]     63%|██████▎   | 94/149 [02:30<01:28,  1.60s/it]     64%|██████▍   | 95/149 [02:32<01:26,  1.60s/it]     64%|██████▍   | 96/149 [02:33<01:24,  1.60s/it]     65%|██████▌   | 97/149 [02:35<01:23,  1.60s/it]     66%|██████▌   | 98/149 [02:37<01:21,  1.60s/it]     66%|██████▋   | 99/149 [02:38<01:20,  1.60s/it]     67%|██████▋   | 100/149 [02:40<01:18,  1.60s/it]     68%|██████▊   | 101/149 [02:41<01:16,  1.60s/it]     68%|██████▊   | 102/149 [02:43<01:15,  1.60s/it]     69%|██████▉   | 103/149 [02:45<01:13,  1.60s/it]     70%|██████▉   | 104/149 [02:46<01:12,  1.61s/it]     70%|███████   | 105/149 [02:48<01:10,  1.61s/it]     71%|███████   | 106/149 [02:49<01:09,  1.61s/it]     72%|███████▏  | 107/149 [02:51<01:07,  1.61s/it]     72%|███████▏  | 108/149 [02:53<01:05,  1.61s/it]     73%|███████▎  | 109/149 [02:54<01:04,  1.61s/it]     74%|███████▍  | 110/149 [02:56<01:02,  1.60s/it]     74%|███████▍  | 111/149 [02:57<01:00,  1.60s/it]     75%|███████▌  | 112/149 [02:59<00:59,  1.60s/it]     76%|███████▌  | 113/149 [03:01<00:57,  1.60s/it]     77%|███████▋  | 114/149 [03:02<00:56,  1.60s/it]     77%|███████▋  | 115/149 [03:04<00:54,  1.60s/it]     78%|███████▊  | 116/149 [03:05<00:52,  1.60s/it]     79%|███████▊  | 117/149 [03:07<00:51,  1.60s/it]     79%|███████▉  | 118/149 [03:09<00:49,  1.60s/it]     80%|███████▉  | 119/149 [03:10<00:48,  1.60s/it]     81%|████████  | 120/149 [03:12<00:46,  1.60s/it]     81%|████████  | 121/149 [03:13<00:44,  1.60s/it]     82%|████████▏ | 122/149 [03:15<00:43,  1.60s/it]     83%|████████▎ | 123/149 [03:17<00:41,  1.60s/it]     83%|████████▎ | 124/149 [03:18<00:40,  1.60s/it]     84%|████████▍ | 125/149 [03:20<00:38,  1.60s/it]     85%|████████▍ | 126/149 [03:21<00:36,  1.60s/it]     85%|████████▌ | 127/149 [03:23<00:35,  1.60s/it]     86%|████████▌ | 128/149 [03:25<00:33,  1.61s/it]     87%|████████▋ | 129/149 [03:26<00:32,  1.61s/it]     87%|████████▋ | 130/149 [03:28<00:30,  1.60s/it]     88%|████████▊ | 131/149 [03:29<00:28,  1.60s/it]     89%|████████▊ | 132/149 [03:31<00:27,  1.60s/it]     89%|████████▉ | 133/149 [03:33<00:25,  1.60s/it]     90%|████████▉ | 134/149 [03:34<00:24,  1.60s/it]     91%|█████████ | 135/149 [03:36<00:22,  1.60s/it]     91%|█████████▏| 136/149 [03:37<00:20,  1.60s/it]     92%|█████████▏| 137/149 [03:39<00:19,  1.60s/it]     93%|█████████▎| 138/149 [03:41<00:17,  1.60s/it]     93%|█████████▎| 139/149 [03:42<00:16,  1.60s/it]     94%|█████████▍| 140/149 [03:44<00:14,  1.60s/it]     95%|█████████▍| 141/149 [03:45<00:12,  1.60s/it]     95%|█████████▌| 142/149 [03:47<00:11,  1.60s/it]     96%|█████████▌| 143/149 [03:49<00:09,  1.61s/it]     97%|█████████▋| 144/149 [03:50<00:08,  1.61s/it]     97%|█████████▋| 145/149 [03:52<00:06,  1.60s/it]     98%|█████████▊| 146/149 [03:54<00:04,  1.60s/it]     99%|█████████▊| 147/149 [03:55<00:03,  1.60s/it]     99%|█████████▉| 148/149 [03:57<00:01,  1.60s/it]    100%|██████████| 149/149 [03:58<00:00,  1.60s/it]    100%|██████████| 149/149 [03:58<00:00,  1.60s/it]




.. GENERATED FROM PYTHON SOURCE LINES 238-252

We obtain the following posterior sample and trajectory

.. container:: image-col

   .. image-sg-ignore:: /auto_examples/images/posterior_sample.png
      :alt: example of posterior sample
      :srcset: /auto_examples/images/posterior_sample.png
      :ignore_missing: true

   .. image-sg-ignore:: /auto_examples/images/posterior_trajectory.gif
      :alt: example of posterior trajectory
      :srcset: /auto_examples/images/posterior_trajectory.gif
      :ignore_missing: true
      :class: custom-gif

.. GENERATED FROM PYTHON SOURCE LINES 255-263

.. note::

    **Reproducibility**: To ensure the reproducibility, if the parameter `rng` is given, the same sample will
    be generated when the same seed is used.
    One can obtain varying samples by using a different seed.

    **Parallel sampling**: one can draw multiple samples in parallel by giving the initial shape, e.g., `x_init = (B, C, H, W)`


.. GENERATED FROM PYTHON SOURCE LINES 265-273

Varying the SDE
---------------

One can also change the underlying SDE for sampling.
For example, we can also use the Variance-Preserving (VP or DDPM) in :class:`deepinv.sampling.VariancePreservingDiffusion`, whose forward drift and diffusion term are defined as:

.. math::
    f(x_t, t) = -\frac{1}{2} \beta(t)x_t \qquad \mbox{ and } \qquad g(t) = \beta(t)  \qquad \mbox{ with } \beta(t) = \beta_{\mathrm{min}}  + t \left( \beta_{\mathrm{max}} - \beta_{\mathrm{min}} \right).

.. GENERATED FROM PYTHON SOURCE LINES 273-316

.. code-block:: Python


    from deepinv.sampling import VariancePreservingDiffusion

    del trajectory
    sde = VariancePreservingDiffusion(device=device, dtype=dtype)
    model = PosteriorDiffusion(
        data_fidelity=dps_fidelity,
        denoiser=denoiser,
        sde=sde,
        solver=solver,
        device=device,
        dtype=dtype,
        verbose=True,
    )

    x_hat_vp, trajectory = model(
        y,
        physics,
        seed=111,
        timesteps=torch.linspace(1, 0.001, 150),
        get_trajectory=True,
    )
    dinv.utils.plot(
        [x_hat, x_hat_vp],
        titles=[
            "posterior sample with VE",
            "posterior sample with VP",
        ],
        save_fn="posterior_sample_ve_vp.png",
        figsize=(figsize * 3, figsize),
    )


    # We can also save the trajectory of the posterior sample
    dinv.utils.save_videos(
        trajectory[::gif_frequency],
        time_dim=0,
        titles=["Posterior sample with VP"],
        save_fn="posterior_trajectory_vp.gif",
        figsize=(figsize, figsize),
    )






.. rst-class:: sphx-glr-script-out

 .. code-block:: none

      0%|          | 0/149 [00:00<?, ?it/s]      1%|          | 1/149 [00:01<03:57,  1.61s/it]      1%|▏         | 2/149 [00:03<03:55,  1.60s/it]      2%|▏         | 3/149 [00:04<03:54,  1.60s/it]      3%|▎         | 4/149 [00:06<03:52,  1.60s/it]      3%|▎         | 5/149 [00:08<03:50,  1.60s/it]      4%|▍         | 6/149 [00:09<03:49,  1.61s/it]      5%|▍         | 7/149 [00:11<03:47,  1.60s/it]      5%|▌         | 8/149 [00:12<03:46,  1.60s/it]      6%|▌         | 9/149 [00:14<03:44,  1.60s/it]      7%|▋         | 10/149 [00:16<03:43,  1.61s/it]      7%|▋         | 11/149 [00:17<03:41,  1.61s/it]      8%|▊         | 12/149 [00:19<03:39,  1.60s/it]      9%|▊         | 13/149 [00:20<03:38,  1.60s/it]      9%|▉         | 14/149 [00:22<03:36,  1.60s/it]     10%|█         | 15/149 [00:24<03:34,  1.60s/it]     11%|█         | 16/149 [00:25<03:33,  1.60s/it]     11%|█▏        | 17/149 [00:27<03:31,  1.60s/it]     12%|█▏        | 18/149 [00:28<03:29,  1.60s/it]     13%|█▎        | 19/149 [00:30<03:28,  1.60s/it]     13%|█▎        | 20/149 [00:32<03:26,  1.60s/it]     14%|█▍        | 21/149 [00:33<03:25,  1.60s/it]     15%|█▍        | 22/149 [00:35<03:23,  1.60s/it]     15%|█▌        | 23/149 [00:36<03:22,  1.60s/it]     16%|█▌        | 24/149 [00:38<03:20,  1.60s/it]     17%|█▋        | 25/149 [00:40<03:18,  1.60s/it]     17%|█▋        | 26/149 [00:41<03:17,  1.60s/it]     18%|█▊        | 27/149 [00:43<03:15,  1.60s/it]     19%|█▉        | 28/149 [00:44<03:13,  1.60s/it]     19%|█▉        | 29/149 [00:46<03:12,  1.60s/it]     20%|██        | 30/149 [00:48<03:10,  1.60s/it]     21%|██        | 31/149 [00:49<03:09,  1.60s/it]     21%|██▏       | 32/149 [00:51<03:07,  1.60s/it]     22%|██▏       | 33/149 [00:52<03:05,  1.60s/it]     23%|██▎       | 34/149 [00:54<03:04,  1.60s/it]     23%|██▎       | 35/149 [00:56<03:02,  1.60s/it]     24%|██▍       | 36/149 [00:57<03:01,  1.60s/it]     25%|██▍       | 37/149 [00:59<02:59,  1.60s/it]     26%|██▌       | 38/149 [01:00<02:57,  1.60s/it]     26%|██▌       | 39/149 [01:02<02:56,  1.60s/it]     27%|██▋       | 40/149 [01:04<02:54,  1.60s/it]     28%|██▊       | 41/149 [01:05<02:53,  1.60s/it]     28%|██▊       | 42/149 [01:07<02:51,  1.60s/it]     29%|██▉       | 43/149 [01:08<02:49,  1.60s/it]     30%|██▉       | 44/149 [01:10<02:48,  1.60s/it]     30%|███       | 45/149 [01:12<02:46,  1.60s/it]     31%|███       | 46/149 [01:13<02:45,  1.60s/it]     32%|███▏      | 47/149 [01:15<02:44,  1.61s/it]     32%|███▏      | 48/149 [01:16<02:42,  1.61s/it]     33%|███▎      | 49/149 [01:18<02:40,  1.61s/it]     34%|███▎      | 50/149 [01:20<02:38,  1.61s/it]     34%|███▍      | 51/149 [01:21<02:37,  1.61s/it]     35%|███▍      | 52/149 [01:23<02:35,  1.60s/it]     36%|███▌      | 53/149 [01:24<02:33,  1.60s/it]     36%|███▌      | 54/149 [01:26<02:32,  1.60s/it]     37%|███▋      | 55/149 [01:28<02:30,  1.60s/it]     38%|███▊      | 56/149 [01:29<02:29,  1.61s/it]     38%|███▊      | 57/149 [01:31<02:27,  1.61s/it]     39%|███▉      | 58/149 [01:33<02:25,  1.60s/it]     40%|███▉      | 59/149 [01:34<02:24,  1.60s/it]     40%|████      | 60/149 [01:36<02:22,  1.60s/it]     41%|████      | 61/149 [01:37<02:21,  1.60s/it]     42%|████▏     | 62/149 [01:39<02:19,  1.60s/it]     42%|████▏     | 63/149 [01:41<02:18,  1.61s/it]     43%|████▎     | 64/149 [01:42<02:16,  1.61s/it]     44%|████▎     | 65/149 [01:44<02:14,  1.60s/it]     44%|████▍     | 66/149 [01:45<02:13,  1.60s/it]     45%|████▍     | 67/149 [01:47<02:11,  1.60s/it]     46%|████▌     | 68/149 [01:49<02:09,  1.60s/it]     46%|████▋     | 69/149 [01:50<02:08,  1.61s/it]     47%|████▋     | 70/149 [01:52<02:06,  1.61s/it]     48%|████▊     | 71/149 [01:53<02:05,  1.61s/it]     48%|████▊     | 72/149 [01:55<02:03,  1.60s/it]     49%|████▉     | 73/149 [01:57<02:01,  1.60s/it]     50%|████▉     | 74/149 [01:58<02:00,  1.60s/it]     50%|█████     | 75/149 [02:00<01:58,  1.60s/it]     51%|█████     | 76/149 [02:01<01:57,  1.60s/it]     52%|█████▏    | 77/149 [02:03<01:55,  1.60s/it]     52%|█████▏    | 78/149 [02:05<01:53,  1.60s/it]     53%|█████▎    | 79/149 [02:06<01:52,  1.60s/it]     54%|█████▎    | 80/149 [02:08<01:50,  1.60s/it]     54%|█████▍    | 81/149 [02:09<01:48,  1.60s/it]     55%|█████▌    | 82/149 [02:11<01:47,  1.60s/it]     56%|█████▌    | 83/149 [02:13<01:45,  1.60s/it]     56%|█████▋    | 84/149 [02:14<01:44,  1.60s/it]     57%|█████▋    | 85/149 [02:16<01:42,  1.61s/it]     58%|█████▊    | 86/149 [02:17<01:41,  1.61s/it]     58%|█████▊    | 87/149 [02:19<01:39,  1.61s/it]     59%|█████▉    | 88/149 [02:21<01:37,  1.61s/it]     60%|█████▉    | 89/149 [02:22<01:36,  1.61s/it]     60%|██████    | 90/149 [02:24<01:34,  1.60s/it]     61%|██████    | 91/149 [02:25<01:33,  1.60s/it]     62%|██████▏   | 92/149 [02:27<01:31,  1.60s/it]     62%|██████▏   | 93/149 [02:29<01:29,  1.60s/it]     63%|██████▎   | 94/149 [02:30<01:28,  1.60s/it]     64%|██████▍   | 95/149 [02:32<01:26,  1.60s/it]     64%|██████▍   | 96/149 [02:33<01:24,  1.60s/it]     65%|██████▌   | 97/149 [02:35<01:23,  1.60s/it]     66%|██████▌   | 98/149 [02:37<01:21,  1.60s/it]     66%|██████▋   | 99/149 [02:38<01:20,  1.60s/it]     67%|██████▋   | 100/149 [02:40<01:18,  1.61s/it]     68%|██████▊   | 101/149 [02:42<01:17,  1.60s/it]     68%|██████▊   | 102/149 [02:43<01:15,  1.60s/it]     69%|██████▉   | 103/149 [02:45<01:13,  1.60s/it]     70%|██████▉   | 104/149 [02:46<01:12,  1.60s/it]     70%|███████   | 105/149 [02:48<01:10,  1.60s/it]     71%|███████   | 106/149 [02:50<01:09,  1.61s/it]     72%|███████▏  | 107/149 [02:51<01:07,  1.60s/it]     72%|███████▏  | 108/149 [02:53<01:05,  1.60s/it]     73%|███████▎  | 109/149 [02:54<01:04,  1.60s/it]     74%|███████▍  | 110/149 [02:56<01:02,  1.60s/it]     74%|███████▍  | 111/149 [02:58<01:00,  1.60s/it]     75%|███████▌  | 112/149 [02:59<00:59,  1.61s/it]     76%|███████▌  | 113/149 [03:01<00:57,  1.60s/it]     77%|███████▋  | 114/149 [03:02<00:56,  1.60s/it]     77%|███████▋  | 115/149 [03:04<00:54,  1.60s/it]     78%|███████▊  | 116/149 [03:06<00:52,  1.60s/it]     79%|███████▊  | 117/149 [03:07<00:51,  1.60s/it]     79%|███████▉  | 118/149 [03:09<00:49,  1.60s/it]     80%|███████▉  | 119/149 [03:10<00:48,  1.60s/it]     81%|████████  | 120/149 [03:12<00:46,  1.60s/it]     81%|████████  | 121/149 [03:14<00:44,  1.60s/it]     82%|████████▏ | 122/149 [03:15<00:43,  1.61s/it]     83%|████████▎ | 123/149 [03:17<00:41,  1.61s/it]     83%|████████▎ | 124/149 [03:18<00:40,  1.61s/it]     84%|████████▍ | 125/149 [03:20<00:38,  1.60s/it]     85%|████████▍ | 126/149 [03:22<00:36,  1.60s/it]     85%|████████▌ | 127/149 [03:23<00:35,  1.60s/it]     86%|████████▌ | 128/149 [03:25<00:33,  1.60s/it]     87%|████████▋ | 129/149 [03:26<00:32,  1.60s/it]     87%|████████▋ | 130/149 [03:28<00:30,  1.60s/it]     88%|████████▊ | 131/149 [03:30<00:28,  1.61s/it]     89%|████████▊ | 132/149 [03:31<00:27,  1.61s/it]     89%|████████▉ | 133/149 [03:33<00:25,  1.60s/it]     90%|████████▉ | 134/149 [03:34<00:24,  1.60s/it]     91%|█████████ | 135/149 [03:36<00:22,  1.60s/it]     91%|█████████▏| 136/149 [03:38<00:20,  1.60s/it]     92%|█████████▏| 137/149 [03:39<00:19,  1.60s/it]     93%|█████████▎| 138/149 [03:41<00:17,  1.60s/it]     93%|█████████▎| 139/149 [03:42<00:16,  1.60s/it]     94%|█████████▍| 140/149 [03:44<00:14,  1.60s/it]     95%|█████████▍| 141/149 [03:46<00:12,  1.60s/it]     95%|█████████▌| 142/149 [03:47<00:11,  1.60s/it]     96%|█████████▌| 143/149 [03:49<00:09,  1.60s/it]     97%|█████████▋| 144/149 [03:50<00:08,  1.60s/it]     97%|█████████▋| 145/149 [03:52<00:06,  1.60s/it]     98%|█████████▊| 146/149 [03:54<00:04,  1.60s/it]     99%|█████████▊| 147/149 [03:55<00:03,  1.60s/it]     99%|█████████▉| 148/149 [03:57<00:01,  1.60s/it]    100%|██████████| 149/149 [03:59<00:00,  1.60s/it]    100%|██████████| 149/149 [03:59<00:00,  1.60s/it]




.. GENERATED FROM PYTHON SOURCE LINES 336-357

We can comparing the sampling trajectory depending on the underlying SDE

.. container:: image-col

   .. image-sg-ignore:: /auto_examples/images/posterior_sample_ve_vp.png
      :alt: posterior sample with VP
      :srcset: /auto_examples/images/posterior_sample_ve_vp.png
      :ignore_missing: true
   .. container:: image-row

      .. image-sg-ignore:: /auto_examples/images/posterior_trajectory.gif
          :alt: posterior trajectory with VE
          :srcset: /auto_examples/images/posterior_trajectory.gif
          :ignore_missing: true
          :class: custom-gif

      .. image-sg-ignore:: /auto_examples/images/posterior_trajectory_vp.gif
          :alt: posterior trajectory with VP
          :srcset: /auto_examples/images/posterior_trajectory_vp.gif
          :ignore_missing: true
          :class: custom-gif

.. GENERATED FROM PYTHON SOURCE LINES 359-365

Plug-and-play Posterior Sampling with arbitrary denoisers
---------------------------------------------------------

The :class:`deepinv.sampling.PosteriorDiffusion` class can be used together with any (well-trained) denoisers for posterior sampling.
For example, we can use the :class:`deepinv.models.DRUNet` for posterior sampling.
We can also change the underlying SDE, for example change the `sigma_max` value.

.. GENERATED FROM PYTHON SOURCE LINES 365-429

.. code-block:: Python


    del trajectory  # clean memory
    sigma_min = 0.001
    sigma_max = 10.0
    rng = torch.Generator(device)
    dtype = torch.float32
    timesteps = torch.linspace(1, 0.001, 250)
    solver = EulerSolver(timesteps=timesteps, rng=rng)
    denoiser = dinv.models.DRUNet(pretrained="download").to(device)

    sde = VarianceExplodingDiffusion(
        sigma_max=sigma_max, sigma_min=sigma_min, alpha=0.75, device=device, dtype=dtype
    )
    x = dinv.utils.load_example(
        "butterfly.png",
        img_size=256,
        resize_mode="resize",
    ).to(device)

    mask = torch.ones_like(x)
    mask[..., 70:150, 120:180] = 0
    physics = dinv.physics.Inpainting(
        mask=mask,
        img_size=x.shape[1:],
        device=device,
    )

    y = physics(x)
    model = PosteriorDiffusion(
        data_fidelity=DPSDataFidelity(denoiser=denoiser, weight=0.3),
        denoiser=denoiser,
        sde=sde,
        solver=solver,
        dtype=dtype,
        device=device,
        verbose=True,
    )

    # To perform posterior sampling, we need to provide the measurements, the physics and the solver.
    x_hat, trajectory = model(
        y=y,
        physics=physics,
        seed=12,
        get_trajectory=True,
    )

    # Here, we plot the original image, the measurement and the posterior sample
    dinv.utils.plot(
        [x, y, x_hat.clip(0, 1)],
        titles=["Original", "Measurement", "Posterior sample DRUNet"],
        figsize=(figsize * 3, figsize),
        save_fn="posterior_sample_DRUNet.png",
    )

    # We can also save the trajectory of the posterior sample
    dinv.utils.save_videos(
        trajectory[::gif_frequency].clip(0, 1),
        time_dim=0,
        titles=["Posterior trajectory DRUNet"],
        save_fn="posterior_sample_DRUNet.gif",
        figsize=(figsize, figsize),
    )






.. rst-class:: sphx-glr-script-out

 .. code-block:: none

      0%|          | 0/249 [00:00<?, ?it/s]      0%|          | 1/249 [00:04<20:03,  4.85s/it]      1%|          | 2/249 [00:09<19:58,  4.85s/it]      1%|          | 3/249 [00:14<19:51,  4.84s/it]      2%|▏         | 4/249 [00:19<19:46,  4.84s/it]      2%|▏         | 5/249 [00:24<19:41,  4.84s/it]      2%|▏         | 6/249 [00:29<19:36,  4.84s/it]      3%|▎         | 7/249 [00:33<19:31,  4.84s/it]      3%|▎         | 8/249 [00:38<19:25,  4.84s/it]      4%|▎         | 9/249 [00:43<19:21,  4.84s/it]      4%|▍         | 10/249 [00:48<19:16,  4.84s/it]      4%|▍         | 11/249 [00:53<19:10,  4.84s/it]      5%|▍         | 12/249 [00:58<19:05,  4.83s/it]      5%|▌         | 13/249 [01:02<19:00,  4.83s/it]      6%|▌         | 14/249 [01:07<18:57,  4.84s/it]      6%|▌         | 15/249 [01:12<18:51,  4.84s/it]      6%|▋         | 16/249 [01:17<18:46,  4.83s/it]      7%|▋         | 17/249 [01:22<18:40,  4.83s/it]      7%|▋         | 18/249 [01:27<18:36,  4.83s/it]      8%|▊         | 19/249 [01:31<18:31,  4.83s/it]      8%|▊         | 20/249 [01:36<18:26,  4.83s/it]      8%|▊         | 21/249 [01:41<18:21,  4.83s/it]      9%|▉         | 22/249 [01:46<18:17,  4.83s/it]      9%|▉         | 23/249 [01:51<18:12,  4.83s/it]     10%|▉         | 24/249 [01:56<18:07,  4.83s/it]     10%|█         | 25/249 [02:00<18:02,  4.83s/it]     10%|█         | 26/249 [02:05<17:59,  4.84s/it]     11%|█         | 27/249 [02:10<17:53,  4.84s/it]     11%|█         | 28/249 [02:15<17:48,  4.84s/it]     12%|█▏        | 29/249 [02:20<17:44,  4.84s/it]     12%|█▏        | 30/249 [02:25<17:39,  4.84s/it]     12%|█▏        | 31/249 [02:29<17:33,  4.83s/it]     13%|█▎        | 32/249 [02:34<17:28,  4.83s/it]     13%|█▎        | 33/249 [02:39<17:24,  4.83s/it]     14%|█▎        | 34/249 [02:44<17:19,  4.83s/it]     14%|█▍        | 35/249 [02:49<17:14,  4.83s/it]     14%|█▍        | 36/249 [02:54<17:09,  4.83s/it]     15%|█▍        | 37/249 [02:58<17:04,  4.83s/it]     15%|█▌        | 38/249 [03:03<17:00,  4.84s/it]     16%|█▌        | 39/249 [03:08<16:56,  4.84s/it]     16%|█▌        | 40/249 [03:13<16:51,  4.84s/it]     16%|█▋        | 41/249 [03:18<16:46,  4.84s/it]     17%|█▋        | 42/249 [03:23<16:41,  4.84s/it]     17%|█▋        | 43/249 [03:27<16:36,  4.84s/it]     18%|█▊        | 44/249 [03:32<16:31,  4.84s/it]     18%|█▊        | 45/249 [03:37<16:26,  4.84s/it]     18%|█▊        | 46/249 [03:42<16:21,  4.83s/it]     19%|█▉        | 47/249 [03:47<16:16,  4.83s/it]     19%|█▉        | 48/249 [03:52<16:12,  4.84s/it]     20%|█▉        | 49/249 [03:56<16:07,  4.84s/it]     20%|██        | 50/249 [04:01<16:02,  4.84s/it]     20%|██        | 51/249 [04:06<15:58,  4.84s/it]     21%|██        | 52/249 [04:11<15:53,  4.84s/it]     21%|██▏       | 53/249 [04:16<15:48,  4.84s/it]     22%|██▏       | 54/249 [04:21<15:43,  4.84s/it]     22%|██▏       | 55/249 [04:25<15:38,  4.84s/it]     22%|██▏       | 56/249 [04:30<15:33,  4.84s/it]     23%|██▎       | 57/249 [04:35<15:28,  4.84s/it]     23%|██▎       | 58/249 [04:40<15:24,  4.84s/it]     24%|██▎       | 59/249 [04:45<15:19,  4.84s/it]     24%|██▍       | 60/249 [04:50<15:14,  4.84s/it]     24%|██▍       | 61/249 [04:55<15:09,  4.84s/it]     25%|██▍       | 62/249 [04:59<15:04,  4.84s/it]     25%|██▌       | 63/249 [05:04<14:59,  4.84s/it]     26%|██▌       | 64/249 [05:09<14:56,  4.84s/it]     26%|██▌       | 65/249 [05:14<14:51,  4.84s/it]     27%|██▋       | 66/249 [05:19<14:46,  4.84s/it]     27%|██▋       | 67/249 [05:24<14:41,  4.84s/it]     27%|██▋       | 68/249 [05:28<14:36,  4.84s/it]     28%|██▊       | 69/249 [05:33<14:32,  4.84s/it]     28%|██▊       | 70/249 [05:38<14:27,  4.84s/it]     29%|██▊       | 71/249 [05:43<14:22,  4.84s/it]     29%|██▉       | 72/249 [05:48<14:17,  4.84s/it]     29%|██▉       | 73/249 [05:53<14:12,  4.84s/it]     30%|██▉       | 74/249 [05:58<14:07,  4.84s/it]     30%|███       | 75/249 [06:02<14:02,  4.84s/it]     31%|███       | 76/249 [06:07<13:58,  4.85s/it]     31%|███       | 77/249 [06:12<13:53,  4.84s/it]     31%|███▏      | 78/249 [06:17<13:48,  4.84s/it]     32%|███▏      | 79/249 [06:22<13:43,  4.84s/it]     32%|███▏      | 80/249 [06:27<13:38,  4.84s/it]     33%|███▎      | 81/249 [06:31<13:34,  4.85s/it]     33%|███▎      | 82/249 [06:36<13:28,  4.84s/it]     33%|███▎      | 83/249 [06:41<13:24,  4.84s/it]     34%|███▎      | 84/249 [06:46<13:19,  4.84s/it]     34%|███▍      | 85/249 [06:51<13:14,  4.84s/it]     35%|███▍      | 86/249 [06:56<13:09,  4.84s/it]     35%|███▍      | 87/249 [07:00<13:05,  4.85s/it]     35%|███▌      | 88/249 [07:05<13:00,  4.85s/it]     36%|███▌      | 89/249 [07:10<12:56,  4.85s/it]     36%|███▌      | 90/249 [07:15<12:51,  4.85s/it]     37%|███▋      | 91/249 [07:20<12:44,  4.84s/it]     37%|███▋      | 92/249 [07:25<12:39,  4.84s/it]     37%|███▋      | 93/249 [07:30<12:35,  4.84s/it]     38%|███▊      | 94/249 [07:34<12:30,  4.84s/it]     38%|███▊      | 95/249 [07:39<12:25,  4.84s/it]     39%|███▊      | 96/249 [07:44<12:20,  4.84s/it]     39%|███▉      | 97/249 [07:49<12:15,  4.84s/it]     39%|███▉      | 98/249 [07:54<12:11,  4.84s/it]     40%|███▉      | 99/249 [07:59<12:06,  4.84s/it]     40%|████      | 100/249 [08:03<12:01,  4.84s/it]     41%|████      | 101/249 [08:08<11:57,  4.85s/it]     41%|████      | 102/249 [08:13<11:50,  4.83s/it]     41%|████▏     | 103/249 [08:18<11:45,  4.83s/it]     42%|████▏     | 104/249 [08:23<11:41,  4.84s/it]     42%|████▏     | 105/249 [08:28<11:36,  4.84s/it]     43%|████▎     | 106/249 [08:32<11:32,  4.84s/it]     43%|████▎     | 107/249 [08:37<11:27,  4.84s/it]     43%|████▎     | 108/249 [08:42<11:22,  4.84s/it]     44%|████▍     | 109/249 [08:47<11:17,  4.84s/it]     44%|████▍     | 110/249 [08:52<11:12,  4.84s/it]     45%|████▍     | 111/249 [08:57<11:07,  4.84s/it]     45%|████▍     | 112/249 [09:01<11:02,  4.84s/it]     45%|████▌     | 113/249 [09:06<10:58,  4.84s/it]     46%|████▌     | 114/249 [09:11<10:53,  4.84s/it]     46%|████▌     | 115/249 [09:16<10:48,  4.84s/it]     47%|████▋     | 116/249 [09:21<10:43,  4.84s/it]     47%|████▋     | 117/249 [09:26<10:38,  4.84s/it]     47%|████▋     | 118/249 [09:31<10:34,  4.84s/it]     48%|████▊     | 119/249 [09:35<10:29,  4.84s/it]     48%|████▊     | 120/249 [09:40<10:24,  4.84s/it]     49%|████▊     | 121/249 [09:45<10:19,  4.84s/it]     49%|████▉     | 122/249 [09:50<10:14,  4.84s/it]     49%|████▉     | 123/249 [09:55<10:09,  4.84s/it]     50%|████▉     | 124/249 [10:00<10:04,  4.84s/it]     50%|█████     | 125/249 [10:04<10:00,  4.84s/it]     51%|█████     | 126/249 [10:09<09:55,  4.84s/it]     51%|█████     | 127/249 [10:14<09:50,  4.84s/it]     51%|█████▏    | 128/249 [10:19<09:45,  4.84s/it]     52%|█████▏    | 129/249 [10:24<09:40,  4.84s/it]     52%|█████▏    | 130/249 [10:29<09:35,  4.84s/it]     53%|█████▎    | 131/249 [10:33<09:31,  4.85s/it]     53%|█████▎    | 132/249 [10:38<09:26,  4.85s/it]     53%|█████▎    | 133/249 [10:43<09:21,  4.84s/it]     54%|█████▍    | 134/249 [10:48<09:16,  4.84s/it]     54%|█████▍    | 135/249 [10:53<09:11,  4.84s/it]     55%|█████▍    | 136/249 [10:58<09:06,  4.84s/it]     55%|█████▌    | 137/249 [11:03<09:02,  4.84s/it]     55%|█████▌    | 138/249 [11:07<08:57,  4.85s/it]     56%|█████▌    | 139/249 [11:12<08:52,  4.84s/it]     56%|█████▌    | 140/249 [11:17<08:47,  4.84s/it]     57%|█████▋    | 141/249 [11:22<08:42,  4.84s/it]     57%|█████▋    | 142/249 [11:27<08:37,  4.84s/it]     57%|█████▋    | 143/249 [11:32<08:33,  4.84s/it]     58%|█████▊    | 144/249 [11:36<08:28,  4.84s/it]     58%|█████▊    | 145/249 [11:41<08:22,  4.83s/it]     59%|█████▊    | 146/249 [11:46<08:17,  4.83s/it]     59%|█████▉    | 147/249 [11:51<08:13,  4.84s/it]     59%|█████▉    | 148/249 [11:56<08:08,  4.84s/it]     60%|█████▉    | 149/249 [12:01<08:03,  4.84s/it]     60%|██████    | 150/249 [12:05<07:59,  4.84s/it]     61%|██████    | 151/249 [12:10<07:54,  4.84s/it]     61%|██████    | 152/249 [12:15<07:49,  4.84s/it]     61%|██████▏   | 153/249 [12:20<07:44,  4.84s/it]     62%|██████▏   | 154/249 [12:25<07:38,  4.83s/it]     62%|██████▏   | 155/249 [12:30<07:34,  4.83s/it]     63%|██████▎   | 156/249 [12:34<07:29,  4.84s/it]     63%|██████▎   | 157/249 [12:39<07:25,  4.84s/it]     63%|██████▎   | 158/249 [12:44<07:20,  4.84s/it]     64%|██████▍   | 159/249 [12:49<07:15,  4.84s/it]     64%|██████▍   | 160/249 [12:54<07:10,  4.84s/it]     65%|██████▍   | 161/249 [12:59<07:05,  4.84s/it]     65%|██████▌   | 162/249 [13:03<07:01,  4.84s/it]     65%|██████▌   | 163/249 [13:08<06:56,  4.85s/it]     66%|██████▌   | 164/249 [13:13<06:50,  4.83s/it]     66%|██████▋   | 165/249 [13:18<06:46,  4.84s/it]     67%|██████▋   | 166/249 [13:23<06:40,  4.83s/it]     67%|██████▋   | 167/249 [13:28<06:36,  4.83s/it]     67%|██████▋   | 168/249 [13:32<06:31,  4.83s/it]     68%|██████▊   | 169/249 [13:37<06:25,  4.82s/it]     68%|██████▊   | 170/249 [13:42<06:21,  4.83s/it]     69%|██████▊   | 171/249 [13:47<06:17,  4.83s/it]     69%|██████▉   | 172/249 [13:52<06:11,  4.82s/it]     69%|██████▉   | 173/249 [13:57<06:06,  4.83s/it]     70%|██████▉   | 174/249 [14:01<06:02,  4.83s/it]     70%|███████   | 175/249 [14:06<05:58,  4.84s/it]     71%|███████   | 176/249 [14:11<05:52,  4.82s/it]     71%|███████   | 177/249 [14:16<05:46,  4.82s/it]     71%|███████▏  | 178/249 [14:21<05:42,  4.83s/it]     72%|███████▏  | 179/249 [14:26<05:38,  4.83s/it]     72%|███████▏  | 180/249 [14:30<05:33,  4.83s/it]     73%|███████▎  | 181/249 [14:35<05:28,  4.83s/it]     73%|███████▎  | 182/249 [14:40<05:23,  4.83s/it]     73%|███████▎  | 183/249 [14:45<05:19,  4.84s/it]     74%|███████▍  | 184/249 [14:50<05:14,  4.84s/it]     74%|███████▍  | 185/249 [14:55<05:09,  4.84s/it]     75%|███████▍  | 186/249 [14:59<05:04,  4.84s/it]     75%|███████▌  | 187/249 [15:04<05:00,  4.84s/it]     76%|███████▌  | 188/249 [15:09<04:55,  4.85s/it]     76%|███████▌  | 189/249 [15:14<04:50,  4.85s/it]     76%|███████▋  | 190/249 [15:19<04:45,  4.85s/it]     77%|███████▋  | 191/249 [15:24<04:41,  4.85s/it]     77%|███████▋  | 192/249 [15:29<04:36,  4.85s/it]     78%|███████▊  | 193/249 [15:33<04:31,  4.84s/it]     78%|███████▊  | 194/249 [15:38<04:26,  4.84s/it]     78%|███████▊  | 195/249 [15:43<04:21,  4.84s/it]     79%|███████▊  | 196/249 [15:48<04:16,  4.84s/it]     79%|███████▉  | 197/249 [15:53<04:11,  4.83s/it]     80%|███████▉  | 198/249 [15:58<04:06,  4.83s/it]     80%|███████▉  | 199/249 [16:02<04:01,  4.84s/it]     80%|████████  | 200/249 [16:07<03:56,  4.83s/it]     81%|████████  | 201/249 [16:12<03:52,  4.83s/it]     81%|████████  | 202/249 [16:17<03:47,  4.84s/it]     82%|████████▏ | 203/249 [16:22<03:42,  4.84s/it]     82%|████████▏ | 204/249 [16:27<03:37,  4.84s/it]     82%|████████▏ | 205/249 [16:31<03:32,  4.83s/it]     83%|████████▎ | 206/249 [16:36<03:27,  4.83s/it]     83%|████████▎ | 207/249 [16:41<03:22,  4.82s/it]     84%|████████▎ | 208/249 [16:46<03:17,  4.82s/it]     84%|████████▍ | 209/249 [16:51<03:12,  4.82s/it]     84%|████████▍ | 210/249 [16:56<03:08,  4.83s/it]     85%|████████▍ | 211/249 [17:00<03:03,  4.84s/it]     85%|████████▌ | 212/249 [17:05<02:59,  4.84s/it]     86%|████████▌ | 213/249 [17:10<02:53,  4.83s/it]     86%|████████▌ | 214/249 [17:15<02:48,  4.82s/it]     86%|████████▋ | 215/249 [17:20<02:43,  4.81s/it]     87%|████████▋ | 216/249 [17:24<02:39,  4.83s/it]     87%|████████▋ | 217/249 [17:29<02:34,  4.83s/it]     88%|████████▊ | 218/249 [17:34<02:29,  4.84s/it]     88%|████████▊ | 219/249 [17:39<02:25,  4.84s/it]     88%|████████▊ | 220/249 [17:44<02:20,  4.83s/it]     89%|████████▉ | 221/249 [17:49<02:14,  4.82s/it]     89%|████████▉ | 222/249 [17:53<02:09,  4.81s/it]     90%|████████▉ | 223/249 [17:58<02:05,  4.81s/it]     90%|████████▉ | 224/249 [18:03<02:00,  4.82s/it]     90%|█████████ | 225/249 [18:08<01:55,  4.82s/it]     91%|█████████ | 226/249 [18:13<01:50,  4.81s/it]     91%|█████████ | 227/249 [18:17<01:45,  4.81s/it]     92%|█████████▏| 228/249 [18:22<01:41,  4.82s/it]     92%|█████████▏| 229/249 [18:27<01:36,  4.82s/it]     92%|█████████▏| 230/249 [18:32<01:31,  4.81s/it]     93%|█████████▎| 231/249 [18:37<01:26,  4.81s/it]     93%|█████████▎| 232/249 [18:42<01:21,  4.81s/it]     94%|█████████▎| 233/249 [18:46<01:17,  4.82s/it]     94%|█████████▍| 234/249 [18:51<01:12,  4.81s/it]     94%|█████████▍| 235/249 [18:56<01:07,  4.81s/it]     95%|█████████▍| 236/249 [19:01<01:02,  4.80s/it]     95%|█████████▌| 237/249 [19:06<00:57,  4.81s/it]     96%|█████████▌| 238/249 [19:10<00:53,  4.82s/it]     96%|█████████▌| 239/249 [19:15<00:48,  4.81s/it]     96%|█████████▋| 240/249 [19:20<00:43,  4.81s/it]     97%|█████████▋| 241/249 [19:25<00:38,  4.81s/it]     97%|█████████▋| 242/249 [19:30<00:33,  4.81s/it]     98%|█████████▊| 243/249 [19:34<00:28,  4.81s/it]     98%|█████████▊| 244/249 [19:39<00:24,  4.81s/it]     98%|█████████▊| 245/249 [19:44<00:19,  4.80s/it]     99%|█████████▉| 246/249 [19:49<00:14,  4.80s/it]     99%|█████████▉| 247/249 [19:54<00:09,  4.81s/it]    100%|█████████▉| 248/249 [19:58<00:04,  4.81s/it]    100%|██████████| 249/249 [20:03<00:00,  4.82s/it]    100%|██████████| 249/249 [20:03<00:00,  4.83s/it]




.. GENERATED FROM PYTHON SOURCE LINES 451-465

We obtain the following posterior trajectory

.. container:: image-col

   .. image-sg-ignore:: /auto_examples/images/posterior_sample_DRUNet.png
      :alt: posterior sample DRUNet
      :srcset: /auto_examples/images/posterior_sample_DRUNet.png
      :ignore_missing: true

   .. image-sg-ignore:: /auto_examples/images/posterior_sample_DRUNet.gif
      :alt: posterior trajectory DRUNet
      :srcset: /auto_examples/images/posterior_sample_DRUNet.gif
      :ignore_missing: true
      :class: custom-gif


.. rst-class:: sphx-glr-timing

   **Total running time of the script:** (30 minutes 12.096 seconds)


.. _sphx_glr_download_auto_examples_sampling_demo_diffusion_sde.py:

.. only:: html

  .. container:: sphx-glr-footer sphx-glr-footer-example

    .. container:: sphx-glr-download sphx-glr-download-jupyter

      :download:`Download Jupyter notebook: demo_diffusion_sde.ipynb <demo_diffusion_sde.ipynb>`

    .. container:: sphx-glr-download sphx-glr-download-python

      :download:`Download Python source code: demo_diffusion_sde.py <demo_diffusion_sde.py>`

    .. container:: sphx-glr-download sphx-glr-download-zip

      :download:`Download zipped: demo_diffusion_sde.zip <demo_diffusion_sde.zip>`


.. only:: html

 .. rst-class:: sphx-glr-signature

    `Gallery generated by Sphinx-Gallery <https://sphinx-gallery.github.io>`_
